-- Refined Test Program: Drop Item from Turtle to Dispenser and Move to Chest
-- Author: OpenAI ChatGPT

-- Function to drop the item in the first slot into the dispenser below
local function dropIntoDispenser()
    turtle.select(1)
    if turtle.getItemCount(1) > 0 then
        local success = turtle.dropDown()  -- Drops item into the dispenser below
        if not success then
            print("Failed to drop item into the dispenser. Is there a dispenser below?")
            return false
        end
    else
        print("No item in the first slot of the turtle.")
        return false
    end
    return true
end

-- Function to move the item from the dispenser to an available slot in a connected chest
local function moveItemToChest(dispenserName)
    local dispenser = peripheral.wrap(dispenserName)
    local items = dispenser.list()
    if not items then
        print("Error: Dispenser has no items or is not recognized correctly.")
        return false
    end

    for slot, item in pairs(items) do
        -- Look for a chest in the network by its simpler peripheral name
        for _, name in ipairs(peripheral.getNames()) do
            if peripheral.getType(name) == "minecraft:chest" then
                local chest = peripheral.wrap(name)
                print("Chest found: " .. name)
                
                -- Move the item to the chest if a slot is found
                for chestSlot = 1, chest.size() do
                    if not chest.list()[chestSlot] then
                        dispenser.pushItems(name, slot, item.count, chestSlot)
                        print("Moved item from dispenser to chest.")
                        return true
                    end
                end
            end
        end
        print("No available slots in any connected chests.")
        return false
    end
end

-- Main test function
local function main()
    -- Drop the item into the dispenser
    if dropIntoDispenser() then
        -- Find the specific dispenser below the turtle
        moveItemToChest("bottom")
    end
end

-- Run the test program
main()
