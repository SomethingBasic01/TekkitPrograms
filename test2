local chestNames = {}
local dispenserName

-- Scan and find peripherals dynamically, including all chest types
local function findPeripherals()
    local peripherals = peripheral.getNames()
    for _, name in ipairs(peripherals) do
        local p = peripheral.wrap(name)
        if p and p.list and name ~= "bottom" then  -- Check for any inventory-like peripheral
            if name:find("dispenser") then
                dispenserName = name
            else
                table.insert(chestNames, name)
            end
        end
    end
end

-- Function to try and push items into a chest
local function tryPushToChest(dispenser, slot, count)
    for _, chestName in ipairs(chestNames) do
        local chest = peripheral.wrap(chestName)
        if chest then
            local moved = dispenser.pushItems(peripheral.getName(chest), slot, count)
            if moved > 0 then
                print("Moved " .. moved .. " items from dispenser to " .. chestName)
                return true
            end
        end
    end
    return false
end

-- Function to transfer items from dispenser to chest
local function transferItems()
    if dispenserName then
        local dispenser = peripheral.wrap(dispenserName)
        
        if dispenser then
            -- Iterate through the dispenser slots
            for slot, item in pairs(dispenser.list()) do
                local success = tryPushToChest(dispenser, slot, item.count)
                if not success then
                    print("Failed to move item from dispenser to any chest. All chests might be full.")
                end
            end
        else
            print("Failed to wrap the dispenser.")
        end
    else
        print("Dispenser not found.")
    end
end

-- Main function to run the program
local function main()
    findPeripherals()

    -- Check if the peripherals are found
    if #chestNames > 0 and dispenserName then
        print("Chests found: " .. table.concat(chestNames, ", "))
        print("Dispenser found: " .. dispenserName)
        transferItems()
    else
        print("Failed to detect necessary peripherals. Cannot proceed.")
    end
end

-- Run the main function
main()
